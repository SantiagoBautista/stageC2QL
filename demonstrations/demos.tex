\documentclass[french]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage[a4paper]{geometry}
\usepackage{babel}
\usepackage{amsmath}
\usepackage{amssymb}
%\usepackage{latexsym} %maybe needed for \Join %nope, it doesn't seem so

\newcommand{\uconcat}{\ensuremath{+\!\!\!+\,}}

\DeclareMathOperator{\proj}{\pi}
\DeclareMathOperator{\sel}{\sigma}
\DeclareMathOperator{\frag}{frag}
\DeclareMathOperator{\defrag}{defrag}
\DeclareMathOperator{\crypt}{crypt}
\DeclareMathOperator{\decrypt}{decrypt}
\DeclareMathOperator{\group}{group}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\ens}{E}
\DeclareMathOperator{\R}{R}
\DeclareMathOperator{\Sc}{S}
\DeclareMathOperator{\s}{sch}
\DeclareMathOperator{\ls}{L}
\DeclareMathOperator{\ru}{Ru}
\DeclareMathOperator{\uni}{Unif}
\DeclareMathOperator{\cor}{cor}
\DeclareMathOperator{\rj}{Rj}
\DeclareMathOperator{\enc}{Enc}
\DeclareMathOperator{\dec}{Dec}
\DeclareMathOperator{\ids}{IDs}
\DeclareMathOperator{\lgr}{lg}
\DeclareMathOperator{\redu}{red}
\DeclareMathOperator{\head}{hd}
\DeclareMathOperator{\tail}{tl}
\DeclareMathOperator{\hfrag}{hfrag}
\DeclareMathOperator{\hdefrag}{hdefrag}

\newcommand\typeT[1]{\text{\ttfamily #1}}
\newcommand{\decryptArgs}[2]{\decrypt_{#1 , \typeT{#2}}}
\newcommand{\cryptArgs}[2]{\crypt_{#1 , \typeT{#2}}}
\newcommand{\projDelta}{\proj_{\delta}}
\newcommand{\selP}{\sel_p}
\newcommand{\decryptCAlpha}{\decryptArgs{\alpha}{c}}
\newcommand{\cryptCAlpha}{\cryptArgs{\alpha}{c}}
\newcommand{\ch}{\typeT{c}}
\newcommand{\chp}{\typeT{c'}}
\newcommand{\groupDelta}{\group_{\delta}}
\newcommand{\fragDelta}{\frag_{\delta}}
\newcommand{\val}{\mathcal{V}}
\newcommand{\cy}[1]{\typeT{c}(#1)}
\newcommand{\dc}[1]{\typeT{c}^{-1}(#1)}
\newcommand{\cip}{\cup \{id\}}
\newcommand{\fold}[3]{\operatorname{fold}_{#1, #2, #3}}
\newcommand{\foldAlphafz}{\fold{\alpha}{f}{z}}
\newcommand{\dilta}{{\delta \cip}}

\newcommand{\intro}[2]{Soit $r$ une relation. On pose $r_1 = (#1)(r) $ et $r_2 = (#2)(r) $}
\newcommand{\dintro}{De même, si $l$ est un élément de $r_2$,}

\begin{document}

\title{Démonstrations des lois algébriques utilisées en C2QL}
\author{Santiago Bautista}
\date{Juin 2017}
\maketitle

\section*{Structure des démonstrations}
Puisque dans toutes les démonstrations qui suivent le but est 
de prouver, sous certaines conditions, l'égalité de deux fonctions $f_1$ et $f_2$
sur $\R$ (ou sur $\R^2$ ou $\R^3$ selon le cas), 
la structure de toutes les démonstrations sera la même:
on considérera $r$ une relation (ou une paire ou un triplet de relations,
selon le cas),
on commencera par montrer que $f_1(r)$ et 
$f_2(r)$ ont le même schéma relationnel,
puis, on montrera que $f_1(r) \subset f_2(r)$
et ensuite que $f_2(r) \subset f_1(r)$.

On aura ainsi démontré par double inclusion que $f_1(r) = f_2(r)$.

\section*{Lois de projection}
\subsection*{Projection et projection}
\begin{align}
\proj_{\delta_1}\circ \dots \circ \proj_{\delta_n} 
& = \proj_{\delta_1 \cap \dots \cap \delta_n}
\end{align}
Soit $r$ une relation.
On pose $r_1 = \proj_{\delta_1}\circ \dots \circ \proj_{\delta_n}(r)$ 
et $r_2 =  \proj_{\delta_1 \cap \dots \cap \delta_n}(r)$

\subsubsection*{Schéma relationnel}
On peut démontrer par récurrence sur $n$ que
le schéma relationnel de $r_1$
est 
$$
\s(r_1) = 
\s(r) \cap \bigcap_{i \in \{ 1, \dots, n \} } \delta_i
$$

De même, par définition de la projection, on a
$$
\s(r_2) = 
\s(r) \cap \bigcap_{i \in \{ 1, \dots, n \} } \delta_i
$$

Donc $\s(r_1) = \s(r_2)$

\subsubsection*{Première inclusion}
Soit $l$ une ligne de $r_1$.

Il existe $l'$ une ligne de $r$ telle que
$
l = {\left( 
	 {\left(    
	  l'|_{\delta_n \cip} 
	 \right)} |_{\dots }
	\right)} |_{\delta_1 \cip}
= l'|_{(\delta_1 \cap \dots \cap \delta_n) \cip}
$
.
Or, par définition de la projection $\proj_{\delta_1 \cap \dots \cap \delta_n}$ ,
on a $l' |_{(\delta_1 \cap \dots \cap \delta_n) \cip} \in r_2$.
Donc $l \in r_2$.

Ainsi, $r_1 \subset r_2$.

\subsubsection*{Deuxième inclusion}
De même, si $l$ est un élément de $r_2$,
alors il existe une ligne $l'$ de $r$ telle que
$l = l' |_{(\delta_1 \cap \dots \cap \delta_n) \cip} = 
 {\left( 
	{\left(    
		l'|_{\delta_n \cip} 
		\right)} |_{\dots }
	\right)} |_{\delta_1 \cip}
$
et, par définition de 
$\proj_{\delta_1}\circ \dots \circ \proj_{\delta_n}$, on a
$
{\left( 
	{\left(    
		l'|_{\delta_n \cip} 
		\right)} |_{\dots }
	\right)} |_{\delta_1 \cip}
\in r_1
$ 
, d'où $l \in r_1$ et $r_2 \subset r_1$.

\subsection*{Projection et sélection}
\begin{align}
\projDelta \circ \selP
& = \selP \circ \projDelta
& \text{si $\dom(p) \subset \delta$}
\end{align}

Soit $\delta$ un ensemble de noms d'attributs
et $p$ un prédicat sur les lignes tel que
$\dom(p) \subset \delta$.

\intro{\projDelta \circ \selP}{\selP \circ \projDelta}

\subsubsection*{Schéma relationnel}
Une sélection ne modifiant jamais le schéma relationnel
d'une relation,
la schéma relation de $r_1$ et de $r_2$ est
$\s(r) \cap \delta$.

\subsubsection*{Première inclusion}
Soit $l$ une ligne de $r_1$.

Il existe une ligne $l'$ de $\selP(r_1)$
telle que $l = l'|_{(\s(r)\cap \delta) \cip}$.

Puisque $l$ et $l'$ coïncident sur $\delta$
et que $\dom(p) \subset \delta$,
on a $p(l) = p(l') = true$.

Or, par définition de $\projDelta$, $l' \in \projDelta(r)$,
donc $l' \in \selP(\projDelta(r)) = r_2$.

Ainsi,
$r_1 \subset r_2$.

\subsubsection*{Deuxième inclusion}
\dintro alors $p(l) = true$ et $l \in \projDelta(r)$
donc il existe une ligne $l'$ dans $r$ telle que 
$l = l'|_{(\s(r)\cap \delta) \cip}$.
$l$ et $l'$ coïncidant sur $\delta$ qui contient
le domaine de $p$, $l'$ vérifie le prédicat $p$
donc $\l' \in \selP(r)$.

On en déduit par définition de $\projDelta$ que
$l \in r_1$.

Ainsi, $r_2 \subset r_1$.

\subsection*{Projection et défragmentation (verticale)}
En appelant $\delta_1$ le schéma relationnel du premier
argument et $\delta_2$ le schéma relationnel du deuxième
argument, on a:
\begin{align}
\projDelta \circ \defrag
& = \defrag \circ (\projDelta, \projDelta)
& \text{si $\delta_1 \cap \delta_2 = \emptyset$}
\end{align}

Soit $\delta$ un ensemble de noms d'attributs.
Soient $r_1$ et $r_2$ deux relations unifiables.

On pose ${res}_1 = (\projDelta \circ \defrag) (r_1, r_2)$
et ${res}_2 = \defrag \circ (\projDelta, \proj_\delta) (r_1, r_2)$.

\paragraph*{Remarque:}
L'hypothèse \og $r_1$ et $r_2$ unifiables \fg{} garantit que
les ${res}_1$ et ${res}_2$ sont bien définies.
En effet, non seulement elle garantit que $\defrag(r_1, r_2)$ existe et donc
que $res_1$ existe (la projection a été définie sur $\R$ tout entier),
mais elle garantit également que $(\delta_1 \cap \delta) \cap (\delta_2 \cap \delta) = \emptyset$
et donc (vu que les projections conservent les identifiants) que
$\projDelta(r_1)$ et $\projDelta(r_2)$ sont unifiables, donc que $res_2$ existe.

\subsubsection*{Schémas relationnels}
Le schéma relationnel de $\defrag(r_1, r_2)$
est $\delta_1 \cup \delta_2$, donc celui de
${res}_1$ est $\delta \cap (\delta_1 \cup \delta_2)$.

Les schémas relationnels de $\projDelta(r_1)$ et de $\projDelta(r_2)$
sont respectivement $\delta \cap \delta_1$ et $\delta \cap \delta_2$,
donc le schéma relationnel de ${res}_2$ est 
$(\delta \cap \delta_1) \cup (\delta \cap \delta_2) = \delta \cap (\delta_1 \cup \delta_2)$


\subsubsection*{Première inclusion}
Soit $l$ une ligne de ${res}_1$.

Il existe $l_0$ une ligne de $\defrag(r_1, r_2)$
de schéma relationnel $\delta_1 \cup \delta_2$
telle que $l = l_0|_{\delta \cip}$.
Il existe donc deux lignes $l_1$ et $l_2$
appartenant respectivement à $r_1$ et $r_2$
telles que
$l_1 = l_0|_{\delta_1 \cip}$
$l_2 = l_0|_{\delta_2 \cip}$

Puisque $l_1$ appartient à $r_1$,
il existe une ligne
$l'_1$ dans $\projDelta(r_1)$
telle que
$l'_1 = l_1|_{\delta \cip} = l_0|_{(\delta \cap \delta_1) \cip}$.
De même,
il existe une ligne
$l'_2$ dans $\projDelta(r_2)$
telle que
$l'_2 = l_2|_{\delta \cip} = l_0|_{(\delta \cap \delta_2) \cip}$. \\

De l'existence de $l'_1$ et 
$l'_2$ qui partagent même identifiant
(et portent sur des schémas relationnels
disjoints)
on en déduit que $l'_1 . l'_2 $ appartient à ${res}_2$.

Or,
\begin{align*}
l'_1 . l'_2 & = l_0|_{((\delta \cap \delta_1) \cip) \cup ((\delta \cap \delta_2) \cip)} \\
	& = l_0|_{(\delta \cap (\delta_1\cup\delta_2)) \cip} \\
	& = \left( l_0|_{\delta_1 \cup \delta_2 \cip} \right)|_{\delta \cip} \\
	& = l_0|_{\delta \cip} = l
\end{align*}

Donc: $l \in {res}_2$.

\subsubsection*{Deuxième inclusion}
Soit $l$ une ligne de ${res}_2$.

Il existe des lignes $l'_1$ et $l'_2$
appartenant respectivement à $\projDelta(r_1)$ et $\projDelta(r_2)$
telles que $l = l'_1 . l'_2$
%ou, autrement dit, $l'_1 = l|_{(\delta_1 \cap \delta) \cip}$
% et $l'_2 = l|_{(\delta_2 \cap \delta) \cip}$
.

On en déduit qu'il existe deux lignes $l_1$ et $l_2$
appartenant respectivement à $r_1$ et $r_2$ 
telles que $l'_1 = l_1|_{\delta \cip}$ et $l'_2 = l_2|_{\delta \cip}$. \\

$r_1$ et $r_2$ étant unifiables, et $l_1$ et $l_2$ ayant même identifiant,
$l_1$ et $_2$ sont des lignes correspondantes et on peut donc considérer
$l_1 . l_2$.

On a d'ailleurs 
$l = l'_1 . l'_2 = (l_1|_{\delta \cip}) . (l_2|_{\delta \cip}) = (l_1 . l_2)|_{\delta \cip}$. \\

Or, $l_1 . l_2$ appartient à $\defrag(r_1, r_2)$
donc $l = (l_1 . l_2)|_{\delta \cip}$ appartient à $ {res}_1$

\subsection*{Projection et déchiffrement d'un attribut projeté ou non}
\begin{align}
\projDelta \circ \decryptArgs{\alpha}{c}
& \equiv \decryptArgs{\alpha}{c} \circ \projDelta
\end{align}
Soit $\delta$ un ensemble de noms d'attributs
et $\alpha$ un attribut (appartenant à $\delta$ ou pas).
\intro{\projDelta \circ \decryptArgs{\alpha}{c}}{\decryptArgs{\alpha}{c} \circ \projDelta}.

\subsubsection*{Schémas relationnels}
Le déchiffrement ne changeant pas le schéma relationnel
d'une relation,le schéma relationnel de $r_1$ et $r_2$
est $\s(r) \cap \delta$.

\subsubsection*{Première inclusion}
Soit $l$ une ligne de $r_1$.

Il existe $l'$ une ligne de $\decryptCAlpha(r)$ telle que
$l = l'|_{\delta \cip}$.
$l'$ étant un élément de $\decryptCAlpha(r)$, il existe une ligne
$l_0$ de $r$ telle que $l' = \dc{l_0}_\alpha$
et donc $l = \dc{l_0}_\alpha|_{\delta \cip}$. \\

Puisque $l_0$ appartient à $r$, $l_0|_{\delta \cip}$
appartient à $\projDelta(r)$ et donc
$\dc{l_0|_{\delta \cip}}_\alpha$ appartient à $r_2$. \\

Montrons que $\dc{l_0}_\alpha|_{\delta \cip} = \dc{l_0|_{\delta \cip}}_\alpha$.
Les deux fonctions en question sont définies sur $(\s(r)\cap \delta) \cip$.

Soit: $\beta \in (\s(r) \cap \delta) \cip$.

Si $\beta \neq \alpha$, on a:
$$
\left\lbrace
\begin{array}{ll}
\dc{l_0}_\alpha|_{\delta \cip}(\beta) 
& = \dc{l_0}_\alpha(\beta) = l_0(\beta) \\
\dc{l_0|_{\delta \cip}}_\alpha (\beta)
& = l_0|_{\delta \cip}(\beta) = l_0(\beta)
\end{array}
\right.
$$

Si $\alpha \in \s(r) \cap \delta$, on a:
$$
\left\lbrace
\begin{array}{ll}
\dc{l_0}_\alpha|_{\delta \cip}(\alpha) 
& = \dc{l_0}_\alpha(\alpha) = \dc{l_0(\alpha} \\
\dc{l_0|_{\delta \cip}}_\alpha (\alpha)
& = \dc{l_0|_{\delta \cip}(\alpha)} = \dc{l_0(\alpha)}
\end{array}
\right.
$$

Ainsi, $\dc{l_0}_\alpha|_{\delta \cip} = \dc{l_0|_{\delta \cip}}_\alpha$
donc $l$ appartient à $r_2$.

\subsubsection*{Deuxième inclusion}
Soit $l$ une ligne de $r_2$.

Il existe une ligne $l'$ de $\projDelta(r)$
telle que $l = \dc{l'}_\alpha$.

Puisque $l'$ appartient à $\projDelta(r)$, 
il existe $l_0$ dans $r$ telle que
$l' = l_0|_\delta$ et donc telle que
$l = \dc{l_0|_{\delta \cip}}_\alpha$. \\

Vu que $l_0$ appartient à $r$, 
$\dc{l_0}_\alpha$ appartient à $\decryptCAlpha(r)$
et $\dc{l_0}_\alpha|_{\delta \cip}$ appartient à $r_1$.

Or, $l_0$ étant une ligne de $r$,
d'après la démonstration faite pour la première inclusion, on a:
$\dc{l_0}_\alpha|_{\delta \cip} = \dc{l_0|_{\delta \cip}}_\alpha$.

On en déduit que $l$ appartient à $r_1$.


\subsection*{Projection et déchiffrement d'un attribut non projeté}
\begin{align}
\projDelta \circ \decryptArgs{\alpha}{c}
& \equiv \projDelta
&\text{si $\alpha \notin \delta$} 
\end{align}

Soit $\delta$ un ensemble de noms d'attributs
et $\alpha$ un attribut n'appartenant pas à $\delta$.
\intro{\projDelta \circ \decryptArgs{\alpha}{c}}{\decryptArgs{\alpha}{c} \circ \projDelta}.

\subsubsection*{Schémas relationnels}
Le déchiffrement ne changeant pas le schéma relationnel
d'une relation,le schéma relationnel de $r_1$ et $r_2$
est $\s(r) \cap \delta$.

\subsubsection*{Inclusions}
La seule chose qui change est la démonstration du fait que 
pour toute ligne $l_0$ de $r$
$\dc{l_0}_\alpha|_{\delta \cip} = \dc{l_0|_{\delta \cip}}_\alpha$.

En effet, si on suppose $\alpha \notin \delta$, un seul cas se présente,
à savoir
$\beta \in (\s(r) \cap \delta) \cip \wedge \beta \neq \alpha$, et on a alors
$$
\left\lbrace
\begin{array}{ll}
\dc{l_0}_\alpha|_{\delta \cip}(\beta) 
& = \dc{l_0}_\alpha(\beta) = l_0(\beta) \\
\dc{l_0|_{\delta \cip}}_\alpha (\beta)
& = l_0|_{\delta \cip}(\beta) = l_0(\beta)
\end{array}
\right.
$$
d'où l'égalité voulue. \\

À partir de là, si $l$ est une ligne de $r_1$,
elle s'écrit $\dc{l_0}_\alpha|_{\delta \cip}$
avec $l_0 \in r$ et $\dc{l_0|_{\delta \cip}}_\alpha$
appartient à $r_2$ donc $l$ appartient à $r_2$.

Inversement, si $l$ est une ligne de $r_2$,
elle s'écrit $\dc{l_0|_{\delta \cip}}_\alpha$
avec $l_0 \in r$ et $\dc{l_0}_\alpha|_{\delta \cip}$
appartient à $r_1$ donc $l$ appartient à $r_1$.

\subsection*{Projection et jointure}
En appelant $\delta_1$ le schéma relationnel du premier
argument et $\delta_2$ le schéma relationnel du deuxième argument,
on a:
\begin{align}
\projDelta \circ \Join
& = \Join \circ (\projDelta, \projDelta)
& \text{si $\delta_1 \cap \delta_2 \subset \delta$}
\end{align}

Soit $\delta$ un ensemble de noms d'attributs,
et $r_1$ et $r_2$ des relations.
On pose $res_1 = (\projDelta \circ \Join)(r_1, r_2)$
et $res_1 = (\Join \circ (\projDelta, \projDelta))(r_1, r_2)$.

\subsubsection*{Schémas relationnels}
Le schéma relationnel de $r_1 \Join r_2$ est
$\s(r_1) \cup \s(r_2)$ donc celui de $res_1$
est $(\s(r_1) \cup \s(r_2)) \cap \delta$.

Les schémas relationnels respectifs de 
$\projDelta(r_1)$ et $\projDelta(r_2)$
sont $\s(r_1) \cap \delta$ et $\s(r_2)\cap \delta$
donc celui de $res_2$ est 
$(\s(r_1)\cap \delta) \cup (\s(r_2)\cap\delta) = (\s(r_1)\cup\s(r_2)) \cap \delta$.

\subsubsection*{Première inclusion}
Soit $l$ une ligne de $res_1$.

Il existe une ligne $l'$ de $r_1 \Join r_2$
telle que $l = l'|_\dilta$.
Puisque $l'$ appartient à $r_1 \Join r_2$,
il existe deux lignes $l_1$ et $l_2$ appartenant
respectivement à $r_1$ et $r_2$ telles que
$l' = l_1.l_2$.
Ainsi, $l = (l_1.l_2)|_\dilta$.

Puisque $l_1$ et $l_2$ se correspondent
et que $\delta_1 \cap \delta_2 \subset \delta$,
$l_1|_\dilta$ et $l_2|_\dilta$ se correspondent aussi.
Or, $l_1|_\dilta$ (respectivement $l_2|_\dilta$)
appartient à $\projDelta(l_1)$ (resp. $\projDelta(r_2)$),
donc $l_1|_\dilta . l_2|_\dilta$ appartient
à $res_2$.

Montrons que $(l_1.l_2)|_\dilta = l_1|_\dilta . l_2|_\dilta$.
Ces deux fonctions sont définies sur $((\delta_1 \cup \delta_2) \cap \delta) \cip$.
Soit $\beta$ un élément de $(\delta_1 \cup \delta_2) \cap \delta$.
$$
(l_1.l_2)|_\dilta(\beta) = l_1.l_2(\beta) =
\left\lbrace
\begin{array}{ll}
l_1(\beta) & \text{si $\beta \in \delta_1$} \\
l_2(\beta) & \text{si $\beta \in \delta_2$}
\end{array}
\right.
$$
$$
l_1|_\dilta . l_2|_\dilta (\beta) = 
\left\lbrace
\begin{array}{ll}
l_1|_\dilta (\beta) = l_1(\beta) & \text{si $\beta \in \delta_1$} \\
l_2|_\dilta (\beta) = l_2(\beta) & \text{si $\beta \in \delta_2$}
\end{array}
\right.
$$
De plus, $(l_1.l_2)|_\dilta(id) = l_1|_\dilta . l_2|_\dilta (id) = l_1(id) . l_2(id)$.
Donc on a bien l'égalité souhaitée et on en déduit que $l$ appartient à $res_2$.

\subsubsection*{Deuxième inclusion}
Soit $l$ une ligne de $res_2$.

Il existe deux lignes $l'_1$ et $l'_2$ de $\projDelta(r_1)$
et $\projDelta(r_2)$ respectivement telles que
$l = l'_1 . l'_2$.
Or, il existe deux lignes $l_1$ et $l_2$ appartenant respectivement
à $r_1$ et $r_2$ telles que 
$l'_1 = l_1 |_\dilta$
et 
$l'_2 = l_2 |_\dilta$.

Donc $l = l_1 |_\dilta . l_2 |_\dilta$. \\

D'autre part,
vu que $l_1|_\dilta$ et $l_2|_\dilta$ se correspondent,
$l_1|_\dilta$ et $l_2|_\dilta$ coïncident sur 
$((\delta_1 \cap \delta) \cap (\delta_2 \cap \delta)$.
Or, $\delta_1 \cap \delta_2 \subset \delta$,
donc $l_1$ et $l_2$ coïncident sur $\delta_1 \cap \delta_2$
donc $l_1$ et $l_2$ se correspondent et donc
$l_1 . l_2$ appartient à $r_1 \Join r_2$.

On en déduit que $\left( l_1 . l_2 \right)|_\dilta$
appartient à $res_1$. \\

Grâce à l'égalité prouvée lors de la preuve de l'autre inclusion,
on en déduit que $l$ appartient à $res_1$.

\end{document}